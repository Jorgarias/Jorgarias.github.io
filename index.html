<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Secciones — inmigración (PMTiles)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0;background:#f0f0f0}
  </style>
</head>
<body>
<div id="map"></div>

<script type="module">
  import { PMTiles, Protocol } from "https://esm.sh/pmtiles@4";

  // --- Rutas / nombres de capas ---
  const PMTILES_RAW = "https://jorgarias.github.io/inmigracion.pmtiles";
  const PMTILES_URL = "pmtiles://" + PMTILES_RAW;
  const LAYER_ID = "secciones";

  const CCAA_URL = "https://jorgarias.github.io/CCAA.geojson";
  const PROV_URL = "https://jorgarias.github.io/PROVINCIA.geojson";

  // Registrar protocolo pmtiles://
  const protocol = new Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Estilo base (fondo gris)
  const style = {
    version: 8,
    sources: {},
    layers: [
      { id: "bg", type: "background", paint: { "background-color": "#f0f0f0" } }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [-3.7, 40.4],
    zoom: 6
  });

  // Gradiente por diff_pct_ext
  const fillColor = [
    "case",
    ["has","diff_pct_ext"],
    ["interpolate", ["linear"], ["get","diff_pct_ext"],
      -47.16126130501527, "#f74545",
      0,                   "#e8e8e8",
      25.71,               "#0154a7"
    ],
    "#cccccc"
  ];

  map.on("load", async () => {
    try {
      // 1) Secciones (PMTiles) — relleno sin bordes
      map.addSource("secciones", { type: "vector", url: PMTILES_URL });
      map.addLayer({
        id: "sec-fill",
        type: "fill",
        source: "secciones",
        "source-layer": LAYER_ID,
        paint: { "fill-color": fillColor, "fill-opacity": 0.9, "fill-antialias": true }
      });

      // 2) Provincias (línea con grosor variable por zoom)
      map.addSource("provincias", { type: "geojson", data: PROV_URL });
      map.addLayer({
        id: "prov-line",
        type: "line",
        source: "provincias",
        layout: { "line-join": "round", "line-cap": "round" },
        paint: {
          "line-color": "#30343b",
          "line-opacity": 0.8,
          "line-width": [
            "interpolate", ["linear"], ["zoom"],
            4, 0.6,
            6, 1.2,
            8, 1.8,
            10, 2.2,
            12, 2.6
          ]
        }
      });

      // 3) CCAA (línea más gruesa, encima)
      map.addSource("ccaa", { type: "geojson", data: CCAA_URL });
      map.addLayer({
        id: "ccaa-line",
        type: "line",
        source: "ccaa",
        layout: { "line-join": "round", "line-cap": "round" },
        paint: {
          "line-color": "#30343b",
          "line-opacity": 0.9,
          "line-width": [
            "interpolate", ["linear"], ["zoom"],
            4, 1.0,
            6, 1.8,
            8, 2.6,
            10, 3.2,
            12, 3.8
          ]
        }
      });

      // 4) Encadre según metadatos del PMTiles (si están disponibles)
      try {
        const p = new PMTiles(PMTILES_RAW);
        const md = await p.getMetadata();
        const b = md.antimeridian_adjusted_bounds || md.bounds;
        if (b) {
          const [w,s,e,n] = b.split(",").map(Number);
          map.fitBounds([[w,s],[e,n]], { padding: 30, duration: 0 });
        }
      } catch (metaErr) {
        // no crítico: si falla, no hacemos fitBounds
        console.warn("No se pudieron leer metadatos PMTiles:", metaErr);
      }

    } catch (e) {
      console.error("Error cargando capas:", e);
      alert("Error cargando datos. Revisa la consola (F12 → Console).");
    }
  });
</script>
</body>
</html>


