<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa PMTiles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    #ui{position:absolute;z-index:1;top:10px;left:10px;background:#fff;padding:8px;border-radius:8px;font:14px sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    select{font:inherit}
  </style>
</head>
<body>
<div id="map"></div>
<div id="ui" hidden>
  Capa: <select id="layerSelect"></select>
</div>

<script type="module">
  import { PMTiles, Protocol } from "https://esm.sh/pmtiles@4";

  const RAW_URL = "https://jorgarias.github.io/inmigracion.pmtiles";
  const PMTILES_URL = "pmtiles://" + RAW_URL;

  // Registrar protocolo pmtiles://
  const protocol = new Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Style con fondo OSM para orientarse (en producción mejor usar tu propio fondo)
  const style = {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "© OpenStreetMap contributors"
      }
    },
    layers: [
      { id: "osm", type: "raster", source: "osm" }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [-3.7, 40.4], // Madrid como fallback
    zoom: 5
  });
  map.addControl(new maplibregl.NavigationControl());

  try {
    // Metadatos del PMTiles
    const p = new PMTiles(RAW_URL);
    const metadata = await p.getMetadata();
    console.log("PMTiles metadata:", metadata);

    // Ajuste de vista si hay info
    if (metadata?.bounds) {
      const [w,s,e,n] = metadata.bounds.split(",").map(Number);
      map.fitBounds([[w,s],[e,n]], { padding: 30, duration: 0 });
    } else if (metadata?.center) {
      const [lon,lat,z] = metadata.center.split(",").map(Number);
      if (!Number.isNaN(lon) && !Number.isNaN(lat)) map.setCenter([lon,lat]);
      if (!Number.isNaN(z)) map.setZoom(z);
    } else if (typeof metadata?.minzoom === "number") {
      map.setZoom(Math.max(0, metadata.minzoom));
    }

    map.on("load", () => {
      const vectorLayers = (metadata?.vector_layers || []).map(l => l.id);

      if (vectorLayers.length > 0) {
        // Fuente vectorial desde PMTiles
        map.addSource("datos", { type: "vector", url: PMTILES_URL });

        const first = vectorLayers[0];

        // Tres capas para cualquier geometría
        map.addLayer({
          id: "overlay-fill",
          type: "fill",
          source: "datos",
          "source-layer": first,
          paint: { "fill-color": "#2b8cbe", "fill-opacity": 0.55 }
        });

        map.addLayer({
          id: "overlay-line",
          type: "line",
          source: "datos",
          "source-layer": first,
          paint: { "line-color": "#1b4f72", "line-width": 0.7 }
        });

        map.addLayer({
          id: "overlay-points",
          type: "circle",
          source: "datos",
          "source-layer": first,
          paint: { "circle-radius": 2.2, "circle-opacity": 0.9 }
        });

        // Selector de capas
        const sel = document.getElementById("layerSelect");
        const ui = document.getElementById("ui");
        vectorLayers.forEach(id => { const o=document.createElement("option"); o.value=id; o.textContent=id; sel.appendChild(o); });
        sel.value = first; ui.hidden = false;

        sel.addEventListener("change", () => {
          ["overlay-fill","overlay-line","overlay-points"].forEach(id => { if (map.getLayer(id)) map.removeLayer(id); });
          map.addLayer({ id:"overlay-fill", type:"fill", source:"datos", "source-layer": sel.value, paint:{ "fill-color":"#2b8cbe", "fill-opacity":0.55 }});
          map.addLayer({ id:"overlay-line", type:"line", source:"datos", "source-layer": sel.value, paint:{ "line-color":"#1b4f72", "line-width":0.7 }});
          map.addLayer({ id:"overlay-points", type:"circle", source:"datos", "source-layer": sel.value, paint:{ "circle-radius":2.2, "circle-opacity":0.9 }});
        });

      } else {
        // Ráster desde PMTiles
        map.addSource("datos_raster", { type: "raster", url: PMTILES_URL, tileSize: 256 });
        map.addLayer({ id: "raster", type: "raster", source: "datos_raster", paint: {"raster-opacity": 0.9} });
      }
    });

  } catch (e) {
    console.error(e);
    alert("No se pudieron leer metadatos del PMTiles. Mira la consola.");
  }
</script>
</body>
</html>
