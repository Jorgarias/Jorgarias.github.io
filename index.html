<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa PMTiles â€” inmigracion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <!-- MapLibre global (no mÃ³dulo) -->
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    #ui{position:absolute;z-index:1;top:10px;left:10px;background:#fff;padding:8px;border-radius:8px;font:14px sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  </style>
</head>
<body>
<div id="map"></div>

<script type="module">
  import { PMTiles, Protocol } from "https://esm.sh/pmtiles@4";

  // --- TU ARCHIVO ---
  const RAW_URL = "https://jorgarias.github.io/inmigracion.pmtiles";
  const PMTILES_URL = "pmtiles://" + RAW_URL;
  const LAYER_ID = "inmigracion";   // ðŸ‘ˆ nombre de la capa dentro del PMTiles

  // Registrar protocolo pmtiles://
  const protocol = new Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Style con fondo OSM para orientarse
  const style = {
    version: 8,
    sources: {
      osm: {
        type: "raster",
        tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "Â© OpenStreetMap contributors"
      }
    },
    layers: [{ id: "osm", type: "raster", source: "osm" }]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [-3.7, 40.4],
    zoom: 5
  });
  map.addControl(new maplibregl.NavigationControl());

  // Lee metadatos para encuadrar y por si hace falta depurar
  const p = new PMTiles(RAW_URL);
  const metadata = await p.getMetadata();
  console.log("PMTiles metadata:", metadata);

  // Encudre con antimeridian_adjusted_bounds si existe
  const boundsStr = metadata.antimeridian_adjusted_bounds || metadata.bounds;
  if (boundsStr) {
    const [w,s,e,n] = boundsStr.split(",").map(Number);
    map.fitBounds([[w,s],[e,n]], { padding: 30, duration: 0 });
  }

  // Pinta la capa vectorial usando el source-layer correcto
  map.on("load", () => {
    map.addSource("datos", { type: "vector", url: PMTILES_URL });

    // Relleno (polÃ­gonos)
    map.addLayer({
      id: "inm-fill",
      type: "fill",
      source: "datos",
      "source-layer": LAYER_ID,
      paint: { "fill-color": "#2b8cbe", "fill-opacity": 0.55 }
    });

    // Contorno
    map.addLayer({
      id: "inm-line",
      type: "line",
      source: "datos",
      "source-layer": LAYER_ID,
      paint: { "line-color": "#1b4f72", "line-width": 0.7 }
    });
  });
</script>
</body>
</html>

