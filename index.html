<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa PMTiles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3/dist/maplibre-gl.css" rel="stylesheet">
  <style>
    html,body,#map{height:100%;margin:0}
    #ui{position:absolute;z-index:1;top:10px;left:10px;background:#fff;padding:8px;border-radius:8px;font:14px sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    select{font:inherit}
  </style>
</head>
<body>
<div id="map"></div>
<div id="ui" hidden>
  Capa: <select id="layerSelect"></select>
</div>

<script type="module">
  // IMPORTS (ESM correctos)
  import * as maplibregl from "https://cdn.jsdelivr.net/npm/maplibre-gl@3/dist/maplibre-gl.js";
  import { PMTiles, Protocol } from "https://cdn.jsdelivr.net/npm/pmtiles@4.3.0/dist/pmtiles.mjs";

  // URL de tu archivo en GitHub Pages
  const RAW_URL = "https://jorgarias.github.io/inmigracion.pmtiles";
  const PMTILES_URL = "pmtiles://" + RAW_URL;

  // Habilita el protocolo pmtiles://
  const protocol = new Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Style base
  const style = {
    version: 8,
    sources: {},
    layers: [{ id: "bg", type: "background", paint: { "background-color": "#eef2f3" } }]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [-3.7038, 40.4168],
    zoom: 6
  });

  // Detecta si el PMTiles es vector o ráster y lo pinta
  try {
    const p = new PMTiles(RAW_URL);
    const metadata = await p.getMetadata();
    const vectorLayers = (metadata?.vector_layers || []).map(l => l.id);
    console.log("PMTiles metadata:", metadata);

    map.on("load", () => {
      if (vectorLayers.length > 0) {
        // ----- VECTOR -----
        map.addSource("datos", { type: "vector", url: PMTILES_URL });

        const first = vectorLayers[0];
        map.addLayer({
          id: "poligonos",
          type: "fill",
          source: "datos",
          "source-layer": first,
          paint: { "fill-color": "#2b8cbe", "fill-opacity": 0.8 }
        });

        // selector de capas
        const sel = document.getElementById("layerSelect");
        const ui = document.getElementById("ui");
        vectorLayers.forEach(id => {
          const o = document.createElement("option");
          o.value = id; o.textContent = id; sel.appendChild(o);
        });
        sel.value = first; ui.hidden = false;

        sel.addEventListener("change", () => {
          if (map.getLayer("poligonos")) map.removeLayer("poligonos");
          map.addLayer({
            id: "poligonos",
            type: "fill",
            source: "datos",
            "source-layer": sel.value,
            paint: { "fill-color": "#2b8cbe", "fill-opacity": 0.8 }
          });
        });

      } else {
        // ----- RÁSTER -----
        map.addSource("datos_raster", { type: "raster", url: PMTILES_URL, tileSize: 256 });
        map.addLayer({ id: "raster", type: "raster", source: "datos_raster" });
      }
    });
  } catch (e) {
    console.error(e);
    alert("Error leyendo metadatos del PMTiles. Revisa la consola (F12 → Console).");
  }
</script>
</body>
</html>
